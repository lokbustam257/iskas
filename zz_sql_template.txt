CREATE DATABASE iska_webgallerydb;
USE iska_webgallerydb;

CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(255) NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    profile_picture VARCHAR(255) NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE images (
    id INT AUTO_INCREMENT PRIMARY KEY,
    image_file VARCHAR(255) NOT NULL,
    description VARCHAR(255) NULL,
    uploader_id INT NULL, -- Changed name to uploader_id and type to INT to match users.id
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- This line creates the relationship
    CONSTRAINT fk_uploader 
    FOREIGN KEY (uploader_id) 
    REFERENCES users(id) 
    ON DELETE SET NULL -- If a user is deleted, keep the image but set uploader to NULL
);

CREATE TABLE roles (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(20) NOT NULL UNIQUE
);

INSERT INTO roles (name) VALUES
('user'),
('moderator'),
('admin');

ALTER TABLE users
ADD role_id INT NOT NULL DEFAULT 1,
ADD CONSTRAINT fk_user_role
FOREIGN KEY (role_id) REFERENCES roles(id);

ALTER TABLE users
MODIFY role_id INT NULL DEFAULT 1;

ALTER TABLE users
ADD CONSTRAINT fk_user_role
FOREIGN KEY (role_id)
REFERENCES roles(id)
ON DELETE SET NULL
ON UPDATE CASCADE;

CREATE TABLE tags (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(64) NOT NULL UNIQUE,
  usage_count INT DEFAULT 0
);

CREATE TABLE image_tags (
  image_id INT NOT NULL,
  tag_id INT NOT NULL,
  PRIMARY KEY (image_id, tag_id),
  FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);


CREATE INDEX idx_tag_id ON image_tags(tag_id);
CREATE INDEX idx_image_id ON image_tags(image_id);
CREATE UNIQUE INDEX idx_image_tag ON image_tags(image_id, tag_id);
